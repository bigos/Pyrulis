* Readme

** nginx documentation
https://nginx.org/en/docs/

https://www.freecodecamp.org/news/the-nginx-handbook/

https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-16-04

https://docs.nginx.com/nginx/deployment-guides/setting-up-nginx-demo-environment/

SSL
https://nginx.org/en/docs/http/configuring_https_servers.html

** config
file:/etc/nginx/sites-enabled/

file:/etc/nginx/sites-available/

proxy_pass
https://stackoverflow.com/a/41138553/1395810

#+begin_example
proxy_pass http://127.0.0.1:3000;
#+end_example

** version
#+begin_example
$ nginx -v
nginx version: nginx/1.24.0 (Ubuntu)
#+end_example

** trying configuration
#+begin_example
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    listen 443 default_server ssl;
    listen [::]:443 default_server ssl;
    ssl_reject_handshake on;
    return 444;
}
#+end_example

** testing configuration

#+begin_example
$ sudo nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successfu

$ sudo nginx
$ sudo nginx -s reopen
$ sudo nginx -s reload
#+end_example

http://localhost:80

http://localhost:81

*** this configuration has ran the rails app on port 80

#+begin_example
  upstream app1 {
    server 127.0.0.1:3000;
    keepalive 8;
  }

  upstream app2 {
    server 127.0.0.1:3001;
    keepalive 8;
  }

  server {
      listen 80 default_server;
      listen [::]:80 default_server;
      listen 443 default_server ssl;
      listen [::]:443 default_server ssl;
      ssl_reject_handshake on;
      # return 444;

    location / {
          proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-NginX-Proxy true;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://127.0.0.1:3000;
        proxy_redirect off;

        proxy_http_version 1.1;

        # proxy_pass http://127.0.0.1:3000;
    }
  }


  server {
      listen 81 default_server;
      listen [::]:81 default_server;
      listen 444 default_server ssl;
      listen [::]:444 default_server ssl;
      ssl_reject_handshake on;
      # return 444;

    location / {
          proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_set_header X-NginX-Proxy true;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://127.0.0.1:3001;
        proxy_redirect off;

        proxy_http_version 1.1;

    }
  }
#+end_example


*** SSL
https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-in-ubuntu-16-04

huh? we have self signed certificates for development
file:/etc/nginx/snippets/snakeoil.conf::1

#+begin_example
# SSL
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt

# params for secrecy
sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
#+end_example

https://localhost:443
https://localhost:444
we have errors but the server is listening to the https requests


this example worked

#+begin_example
upstream app1 {
  server 127.0.0.1:3000;
  keepalive 8;
}

upstream app2 {
  server 127.0.0.1:3001;
  keepalive 8;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    listen 443 default_server ssl;
    listen [::]:443 default_server ssl;
    server_name _;

    include snippets/snakeoil.conf;
    # ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
    # ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;

    # ssl_reject_handshake on;
    # return 444;

  location / {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-NginX-Proxy true;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://127.0.0.1:3000;
      proxy_redirect off;

      proxy_http_version 1.1;

      # proxy_pass http://127.0.0.1:3000;
  }
}


server {
    listen 81 default_server;
    listen [::]:81 default_server;
    listen 444 default_server ssl;
    listen [::]:444 default_server ssl;
    server_name _;

    ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;

    # ssl_reject_handshake on;
    # return 444;

  location / {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-NginX-Proxy true;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://127.0.0.1:3001;
      proxy_redirect off;

      proxy_http_version 1.1;

  }
}
#+end_example
